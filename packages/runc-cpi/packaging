set -e -x

if [[ `uname` == "Darwin" ]]; then
  os=darwin
else
  os=linux
fi

if [ -z "$BOSH_PACKAGES_DIR" ]; then
	pkg_dir=$(readlink -nf /var/vcap/packages/golang-1.10-${os})
else
	pkg_dir=$BOSH_PACKAGES_DIR/golang-1.10-${os}
fi

source ${pkg_dir}/bosh/compile.env

mkdir -p ${BOSH_INSTALL_TARGET}/src
cp -a . ${BOSH_INSTALL_TARGET}/src/.

go build \
  -o ${BOSH_INSTALL_TARGET}/bin/cpi \
  github.com/aemengo/bosh-runc-cpi/cmd/cpi