set -e -x

if [[ `uname` == "Darwin" ]]; then
  pkg_dir=${BOSH_PACKAGES_DIR}/golang-1.10-darwin
else
  pkg_dir=${BOSH_PACKAGES_DIR}/golang-1.10-linux
fi

source ${pkg_dir}/bosh/compile.env

export GOROOT=$pkg_dir
export GOPATH=$BOSH_INSTALL_TARGET
export PATH=$PATH:${GOROOT}/bin

mkdir -p ${BOSH_INSTALL_TARGET}/src
cp -a . ${BOSH_INSTALL_TARGET}/src/.

go build \
  -o ${BOSH_INSTALL_TARGET}/bin/cpi \
  github.com/aemengo/bosh-containerd-cpi/cmd/cpi